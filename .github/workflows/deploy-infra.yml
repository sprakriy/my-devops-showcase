name: 'Infrastructure Lifecycle'
on:
  workflow_dispatch:
    inputs:
      target_layer:
        description: 'Layer to Process'
        type: choice
        required: true
        options:
          - layer-1-main (VPC & DB)
          - layer-2-services (DNS & EC2)
      action:
        description: 'Action'
        type: choice
        required: true
        options:
          - plan
          - apply
          - destroy
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for requesting the JWT (OIDC)
      contents: read  # Required for actions/checkout
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Inspect Directory Structure
        run: |
          echo "Current Directory: $(pwd)"
          ls -F
      - name: Setup Node (for Nx)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          # Tell it where the lock file is
          cache-dependency-path: 'showcase-monorepo/package-lock.json'

      - name: Install Dependencies
        run: npm ci
        working-directory: showcase-monorepo

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # PASTE YOUR ROLE ARN HERE
          role-to-assume: arn:aws:iam::319310747432:role/GitHubActionsServiceRole
          aws-region: us-east-1
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.2
          terraform_wrapper: false # This is likely the missing link

      - name: Terraform Init
        working-directory: showcase-monorepo
        run: npx nx run-many -t init
# --- STEP 1: RESTORE MEMORY (Only for Apply) ---
      # This looks for the saved file from your "Plan" run and puts it back
      - name: Download Plan Artifact
        if: github.event.inputs.action == 'apply'
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.target_layer }}-plan
          # We place it exactly where Nx's 'cwd' expects it
          path: showcase-monorepo/libs/${{ github.event.inputs.target_layer }}

      # --- STEP 2: EXECUTION ---
      - name: Execute Layer Logic
        working-directory: showcase-monorepo
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: |
          if [ "${{ github.event.inputs.action }}" == "plan" ]; then
            npx nx run ${{ github.event.inputs.target_layer }}:plan
          elif [ "${{ github.event.inputs.action }}" == "apply" ]; then
            npx nx run ${{ github.event.inputs.target_layer }}:apply
          elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            npx nx run ${{ github.event.inputs.target_layer }}:destroy --args="-auto-approve"
          fi

      # --- STEP 3: SAVE MEMORY (Only for Plan) ---
      # After the Plan runs, we grab the file and save it to the GitHub Cloud
      - name: Upload Plan Artifact
        if: github.event.inputs.action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.target_layer }}-plan
          path: showcase-monorepo/libs/${{ github.event.inputs.target_layer }/tfplan
          retention-days: 1 # Only need it for 24 hours
# --- DOWNLOAD (Apply Phase) ---
      - name: Download Services Plans
        if: github.event.inputs.target_layer == 'layer-2-services' && github.event.inputs.action == 'apply'
        uses: actions/download-artifact@v4
        with:
          name: layer-2-services-plans
          path: showcase-monorepo/libs/
          
      # --- EXECUTION ---
      - name: Execute Services
        if: github.event.inputs.target_layer == 'layer-2-services'
        working-directory: showcase-monorepo
        run: |
          if [ "${{ github.event.inputs.action }}" == "plan" ]; then
            npx nx run infra-dns:plan
            npx nx run infra-app:plan
          elif [ "${{ github.event.inputs.action }}" == "apply" ]; then
            npx nx run infra-dns:apply
            npx nx run infra-app:apply
          fi

      # --- UPLOAD (Plan Phase) ---
      - name: Upload Services Plans
        if: github.event.inputs.target_layer == 'layer-2-services' && github.event.inputs.action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: layer-2-services-plans
          # We grab the tfplan files from BOTH folders
          path: |
            showcase-monorepo/libs/infra-dns/tfplan
            showcase-monorepo/libs/infra-app/tfplan