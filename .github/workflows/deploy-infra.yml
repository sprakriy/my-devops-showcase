name: 'Infrastructure Lifecycle'
on:
  workflow_dispatch:
    inputs:
      target_layer:
        description: 'Select Infrastructure Layer'
        type: choice
        required: true
        options:
          - layer-1-main
          - layer-2-services
      action:
        description: 'Select Action'
        type: choice
        required: true
        options:
          - plan
          - apply
          - destroy
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'showcase-monorepo/package-lock.json'

      - name: Install Dependencies
        run: npm ci
        working-directory: showcase-monorepo

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::319310747432:role/GitHubActionsServiceRole
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.2
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: showcase-monorepo
        run: npx nx run-many -t init

      # --- 1. RESTORE MEMORY (Only for Apply) ---
      - name: Download Plan Artifact
        if: github.event.inputs.action == 'apply'
        uses: actions/download-artifact@v4
        with:
          # We use a sanitized name for the artifact
          name: ${{ github.event.inputs.target_layer }}-plan
          path: showcase-monorepo/libs/

      # --- 2. EXECUTION (Unified Logic) ---
      - name: Execute Layer Logic
        working-directory: showcase-monorepo
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: |
          # Map the dropdown choice to actual Nx project names
          if [[ "${{ github.event.inputs.target_layer }}" == *"layer-1-main"* ]]; then
            TARGETS="infra-main"
          else
            TARGETS="infra-dns infra-app"
          fi

          for target in $TARGETS; do
            if [ "${{ github.event.inputs.action }}" == "plan" ]; then
              npx nx run $target:plan --args="-out=tfplan"
            elif [ "${{ github.event.inputs.action }}" == "apply" ]; then
              npx nx run $target:apply
            elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
              npx nx run $target:destroy --args="-auto-approve"
            fi
          done

      # --- 3. SAVE MEMORY (Only for Plan) ---
      - name: Upload Plan Artifact
        if: github.event.inputs.action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.target_layer }}-plan
          path: showcase-monorepo/libs/**/tfplan
          retention-days: 1