name: 'Infrastructure Lifecycle'
on:
  workflow_dispatch:
    inputs:
      target_layer:
        description: 'Layer to Process'
        type: choice
        required: true
        options:
          - layer-1-main (VPC & DB)
          - layer-2-services (DNS & EC2)
      action:
        description: 'Action'
        type: choice
        required: true
        options:
          - plan
          - apply
          - destroy
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for requesting the JWT (OIDC)
      contents: read  # Required for actions/checkout
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Inspect Directory Structure
        run: |
          echo "Current Directory: $(pwd)"
          ls -F
      - name: Setup Node (for Nx)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          # Tell it where the lock file is
          cache-dependency-path: 'showcase-monorepo/package-lock.json'

      - name: Install Dependencies
        run: npm ci
        working-directory: showcase-monorepo

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # PASTE YOUR ROLE ARN HERE
          role-to-assume: arn:aws:iam::319310747432:role/GitHubActionsServiceRole
          aws-region: us-east-1
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.2
          terraform_wrapper: false # This is likely the missing link

      - name: Terraform Init
        working-directory: showcase-monorepo
        run: npx nx run-many -t init
# This runs the chosen action (plan/apply/destroy) for all projects in the monorepo
      - name: Execute Layered Logic
        working-directory: showcase-monorepo
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: |
          # --- CASE 1: FOUNDATION (Network/DB) ---
          if [ "${{ github.event.inputs.target_layer }}" == "layer-1-main" ]; then
            if [ "${{ github.event.inputs.action }}" == "plan" ]; then
              npx nx run infra-main:plan
            elif [ "${{ github.event.inputs.action }}" == "apply" ]; then
              npx nx run infra-main:apply --args="-auto-approve"
            elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
              # This will only succeed if layer-2 is ALREADY gone
              npx nx run infra-main:destroy --args="-auto-approve"
            fi

          # --- CASE 2: SERVICES (DNS/EC2) ---
          elif [ "${{ github.event.inputs.target_layer }}" == "layer-2-services" ]; then
            if [ "${{ github.event.inputs.action }}" == "plan" ]; then
              npx nx run infra-dns:plan
              npx nx run infra-app:plan
            elif [ "${{ github.event.inputs.action }}" == "apply" ]; then
              npx nx run infra-dns:apply --args="-auto-approve"
              npx nx run infra-app:apply --args="-auto-approve"
            elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
              # Always destroy services FIRST
              npx nx run infra-app:destroy --args="-auto-approve"
              npx nx run infra-dns:destroy --args="-auto-approve"
            fi
          fi