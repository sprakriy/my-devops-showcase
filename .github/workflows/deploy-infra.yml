name: 'Infrastructure Lifecycle'
on:
  workflow_dispatch:
    inputs:
      target_layer:
        description: 'Select Infrastructure Layer'
        type: choice
        required: true
        options:
          - layer-1-main
          - layer-2-services
      action:
        description: 'Select Action'
        type: choice
        required: true
        options:
          - plan
          - apply
          - destroy
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'showcase-monorepo/package-lock.json'

      - name: Install Dependencies
        run: npm ci
        working-directory: showcase-monorepo

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::319310747432:role/GitHubActionsServiceRole
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.2
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: showcase-monorepo
        run: npx nx run-many -t init
      - name: Set Internal Variables
        id: vars
        run: |
          if [[ "${{ github.event.inputs.target_layer }}" == *"layer-1-main"* ]]; then
            echo "layer_id=layer-1-main" >> $GITHUB_OUTPUT
            echo "targets=infra-main" >> $GITHUB_OUTPUT
          else
            echo "layer_id=layer-2-services" >> $GITHUB_OUTPUT
            echo "targets=infra-dns infra-app" >> $GITHUB_OUTPUT
          fi

      # --- 2. EXECUTION (Unified Logic) ---
# --- 1. EXECUTION ---
      - name: Execute Layer Logic
        working-directory: showcase-monorepo
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: |
          if [ -n "$TF_VAR_db_password" ]; then
              echo "TF_VAR_db_password is set."
          else
              echo "TF_VAR_db_password is not set. (length: ${#TF_VAR_db_password}) "
              exit 1
          fi

          # Map targets based on selection
          if [[ "${{ github.event.inputs.target_layer }}" == *"layer-1-main"* ]]; then
            TARGETS="infra-main"
          else
            TARGETS="infra-dns infra-app"
          fi

          for target in $TARGETS; do
            if [ "${{ github.event.inputs.action }}" == "plan" ]; then
              # PLAN: Create file and upload to S3
              npx nx run $target:plan --args="-out=tfplan"
              aws s3 cp libs/$target/tfplan s3://sp-01182026-infra-terraform-state/plans/$target-tfplan

            elif [ "${{ github.event.inputs.action }}" == "apply" ]; then
              # APPLY: Download from S3 then apply
              aws s3 cp s3://sp-01182026-infra-terraform-state/plans/$target-tfplan libs/$target/tfplan
              npx nx run $target:apply
            
            elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
              npx nx run $target:destroy --args="-auto-approve"
            fi
          done